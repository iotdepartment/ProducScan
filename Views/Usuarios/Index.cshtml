@model IEnumerable<ProducScan.Models.Usuario>
@{
    ViewData["Title"] = "Administrar Usuarios";
     ViewData["Subtitle"] = "Team Members registrados en el Sistema de escaneo de Inspección.";
}

<div class="d-flex justify-content-between mb-3">
    <button class="btn btn-primary rounded-pill" id="btnNuevo">
        <i class="bi bi-person-plus"></i> Nuevo Usuario
    </button>
</div>

<div id="tablaUsuariosContainer">
    @await Html.PartialAsync("_TablaUsuarios", Model)
</div>

<!-- Modal genérico -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="modalContent">
            <!-- Aquí se carga el partial -->
        </div>
    </div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="toastSuccess" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
        const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
        const toastError = new bootstrap.Toast(document.getElementById('toastError'));

        function showToast(success, message) {
            if (success) {
                document.querySelector("#toastSuccess .toast-body").innerText = message;
                toastSuccess.show();
            } else {
                document.querySelector("#toastError .toast-body").innerText = message;
                toastError.show();
            }
        }

        // Nuevo usuario
        $("#btnNuevo").click(function () {
            $("#modalContent").load("/Usuarios/Crear", function () {
                modal.show();
            });
        });

        // Editar usuario
        $(document).on("click", ".btnEditar", function () {
            let id = $(this).data("id");
            $("#modalContent").load("/Usuarios/Editar/" + id, function () {
                modal.show();
            });
        });

        // Eliminar usuario
        $(document).on("click", ".btnEliminar", function () {
            let id = $(this).data("id");
            $("#modalContent").load("/Usuarios/Eliminar/" + id, function () {
                modal.show();
            });
        });

        function refreshTabla() {
            $("#tablaUsuariosContainer").load("/Usuarios/TablaUsuarios");
        }

        $(document).on("submit", "form.ajaxForm", function (e) {
            e.preventDefault();
            let form = $(this);
            $.post(form.attr("action"), form.serialize())
                .done(function (res) {
                    if (res.success) {
                        modal.hide();
                        refreshTabla();
                        showToast(true, res.message);
                    } else {
                        showToast(false, res.message);
                    }
                })
                .fail(function () {
                    showToast(false, "Error en la petición.");
                });
        });
    </script>
}