@{
    ViewData["Title"] = "Usuarios";
}

<h2>Usuarios</h2>

<button class="btn btn-success mb-3 rounded rounded-pill" data-bs-toggle="modal" data-bs-target="#createEditModal"
        onclick="openCreateModal()">
    Nuevo Usuario
</button>

<table id="usersTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Número de Empleado</th>
            <th>Nombre</th>
            <th>Acciones</th>
        </tr>
    </thead>
</table>
<!-- Toast único -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
    <div id="mainToast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">
                Mensaje aquí
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Partial con modal Create/Edit -->
@await Html.PartialAsync("_CreateEditModal")

<!-- Modal Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" asp-action="Delete" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deleteId" name="id" />
                    <p>¿Seguro que deseas eliminar este usuario?</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>



@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
               var table;

        $(document).ready(function () {
            table = $('#usersTable').DataTable({   // 👈 aquí asignas a la variable
                ajax: {
                    url: "/RegistrodeUsers/GetUsers",
                    type: "GET",
                    datatype: "json"
                },
                columns: [
                    { data: "numerodeEmpleado" },
                    { data: "nombre" },
                    {
                        data: "id",
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning" onclick="openEditModal(${data}, '${row.numerodeEmpleado}', '${row.nombre}')">Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${data})">Eliminar</button>
                            `;
                        }
                    }
                ],
                pageLength: 10,
                lengthMenu: [10, 20, 50, 100],
                ordering: false,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" }
            });

            // Submit Create/Edit
            $("#createEditForm").submit(function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    type: "POST",
                    url: form.attr("action"),
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $('#createEditModal').modal('hide');
                            $('#deleteModal').modal('hide');
                            showToast(res.message, true);
                            table.ajax.reload(null, false); // ✅ ahora sí funciona
                        } else {
                            if (res.errors && res.errors.length > 0) {
                                showToast(res.errors.join("\n"), false);
                            } else {
                                showToast(res.message, false);
                            }
                        }
                    }
                });
            });

            // Submit Delete
            $("#deleteForm").submit(function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    type: "POST",
                    url: form.attr("action"),
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $('#createEditModal').modal('hide');
                            $('#deleteModal').modal('hide');
                            showToast(res.message, true);
                            table.ajax.reload(null, false); // ✅ ahora sí funciona
                        } else {
                            if (res.errors && res.errors.length > 0) {
                                showToast(res.errors.join("\n"), false);
                            } else {
                                showToast(res.message, false);
                            }
                        }
                    }
                });
            });
        });

                $('#createEditModal').on('hidden.bs.modal', function () {
            // Limpia todos los campos del formulario
            $(this).find('form')[0].reset();
            // Quita clases de validación de Bootstrap
            $(this).find('form').removeClass('was-validated');
        });

                  function openCreateModal() {
            document.getElementById("modalTitle").innerText = "Crear Usuario";
            document.getElementById("createEditForm").action = "/RegistrodeUsers/Create";
            document.getElementById("userId").value = ""; // 👈 vacío en create
            document.getElementById("numeroEmpleado").value = "";
            document.getElementById("nombre").value = "";
        }


                    function openEditModal(id, numero, nombre) {
            document.getElementById("modalTitle").innerText = "Editar Usuario";
            document.getElementById("createEditForm").action = "/RegistrodeUsers/Edit";
            document.getElementById("userId").value = id; // 👈 aquí sí existe
            document.getElementById("numeroEmpleado").value = numero;
            document.getElementById("nombre").value = nombre;
            $('#createEditModal').modal('show');
        }

        function openDeleteModal(id) {
            document.getElementById("deleteId").value = id;
            $('#deleteModal').modal('show');
        }

        function showToast(message, isSuccess = true) {
            const toastEl = document.getElementById("mainToast");
            const toastBody = document.getElementById("toastMessage");

            // Limpia clases previas
            toastEl.classList.remove("text-bg-success", "text-bg-danger");

            // Aplica color según el tipo
            if (isSuccess) {
                toastEl.classList.add("text-bg-success");
            } else {
                toastEl.classList.add("text-bg-danger");
            }

            // Cambia el mensaje
            toastBody.innerText = message;

            // Muestra el toast
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    </script>
}