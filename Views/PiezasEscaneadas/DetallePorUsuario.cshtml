@model List<ProducScan.ViewModels.ProduccionDetalleViewModel>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    var usuario = ViewBag.Usuario as string;
    var fecha = ViewBag.Fecha as string;

    ViewData["Title"] = "Producción por TM";
    ViewData["PageTitle"] = "PRODUCCION POR TEAM MEMBER";
    ViewData["PageDescription"] = "Producción desglozada por día de cada TM.";
    // ViewData["FullWidth"] = true;
}


@if (Model.Any())
{
    <div class="card mb-3 shadow-sm border-0 rounded-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title">Producción del día</h5>
                <p class="card-text">
                    <strong>Fecha laboral:</strong> @ViewBag.FechaLaboral
                </p>
                <p class="card-text">
                    <strong>Team Member:</strong> @ViewBag.Usuario
                </p>
            </div>
            <div class="tm-photo text-center">
                <img src="@ViewBag.FotoUrl"
                     alt="Foto de @ViewBag.Usuario"
                     class="rounded-circle shadow-sm"
                     style="width:80px;height:80px;object-fit:cover;border:3px solid #fff;" />
            </div>
        </div>
    </div>

    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Fecha laboral</th>
                <th>Fecha real</th>
                <th>Hora</th>
                <th>Mesa</th>
                <th>Turno</th>
                <th>Mandrel</th>
                <th>Piezas</th>
                @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                {
                    <th>Acciones</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.FechaLaboral.ToString("yyyy-MM-dd")</td>
                    <td>@item.FechaReal.ToString("yyyy-MM-dd")</td>
                    <td>@item.Hora</td>
                    <td>@item.NuMesa</td>
                    <td>@item.Turno</td>
                    <td>@item.Mandrel</td>
                    <td>@item.NumeroDePiezas</td>

                    @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                    {
                        <td>

                        <button class="btn btn-warning btn-sm btnEditar rounded-circle"
                                data-id="@item.Id">
                            <i class="bi bi-pencil-fill"></i>
                        </button>

                        <button class="btn btn-danger btn-sm btnEliminar rounded-circle"
                                data-id="@item.Id">
                            <i class="bi bi-trash-fill"></i>
                        </button>

                    </td>
                    }
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No hay datos disponibles para este usuario en esta fecha.</p>
}
<a asp-action="ReporteProduccion" class="btn btn-secondary mt-3 rounded-pill">← Volver</a>

<!-- Modal -->
<div class="modal fade" id="modalCrud" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="modalContent">

        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

@section Scripts {
    <script>
        // Abrir modal de edición
        $(document).on("click", ".btnEditar", function () {
            var id = $(this).data("id");

            $.get("/PiezasEscaneadas/EditarModal", { id: id }, function (html) {
                $("#modalContent").html(html);
                $("#modalCrud").modal("show");
            });
        });

        // Submit de formularios Update/Delete
        $(document).on("submit", "#formUpdate, #formDelete", function (e) {
            e.preventDefault();

            $.ajax({
                type: "POST",
                url: $(this).attr("action"),
                data: $(this).serialize(),
                success: function (res) {
                    if (res.success) {
                        $("#modalCrud").modal("hide");
                        mostrarToast("success", res.message || "Operación realizada correctamente");
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        mostrarToast("danger", res.error || "Ocurrió un error inesperado");
                    }
                },
                error: function (xhr) {
                    mostrarToast("danger", "Error en AJAX: " + xhr.responseText);
                }
            });
        });

        // Mandrel autocomplete
        $(document).on("keyup", "#editMandrel", function () {
            var query = $(this).val();
            if (query.length < 2) {
                $("#mandrelSuggestions").empty();
                return;
            }

            $.get("/PiezasEscaneadas/BuscarMandrels", { term: query }, function (data) {
                var suggestions = $("#mandrelSuggestions");
                suggestions.empty();

                if (data.length === 0) {
                    suggestions.append('<div class="list-group-item">Sin resultados</div>');
                } else {
                    data.forEach(function (item) {
                        suggestions.append('<button type="button" class="list-group-item list-group-item-action mandrel-option">' + item + '</button>');
                    });
                }
            });
        });

        // Al hacer clic en una sugerencia de mandrel
        $(document).on("click", ".mandrel-option", function () {
            var value = $(this).text();
            $("#editMandrel").val(value);
            $("#mandrelSuggestions").empty();
        });


                // TM autocomplete
        $(document).on("keyup", "#editTm", function () {
            var query = $(this).val();
            if (query.length < 2) {
                $("#tmSuggestions").empty();
                return;
            }

            $.get("/PiezasEscaneadas/BuscarTM", { term: query }, function (data) {
                var suggestions = $("#tmSuggestions");
                suggestions.empty();

                if (data.length === 0) {
                    suggestions.append('<div class="list-group-item">Sin resultados</div>');
                } else {
                    data.forEach(function (item) {
                        suggestions.append('<button type="button" class="list-group-item list-group-item-action tm-option">' + item + '</button>');
                    });
                }
            });
        });

        // Al hacer clic en una sugerencia de TM
        $(document).on("click", ".tm-option", function () {
            var value = $(this).text();
            $("#editTm").val(value);
            $("#tmSuggestions").empty();
        });


        // Toast helper
        function mostrarToast(tipo, mensaje) {
            var toastId = "toast-" + Date.now();
            var toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${tipo} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${mensaje}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>`;
            $("#toastContainer").append(toastHtml);

            var toastEl = document.getElementById(toastId);
            var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', function () {
                $(toastEl).remove();
            });
        }

        // Abrir modal de Eliminar
        $(document).on("click", ".btnEliminar", function () {
            var data = $(this).data();
            var token = '@Antiforgery.GetTokens(ViewContext.HttpContext).RequestToken';
            var html = `
                <form id="formDelete" method="post" action="@Url.Action("Delete", "PiezasEscaneadas")">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="__RequestVerificationToken" value="${token}" />
                        <input type="hidden" name="Id" value="${data.id}" />
                        <p>¿Estás seguro de que deseas borrar este registro?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger rounded-pill">Sí, borrar</button>
                        <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>`;
            $("#modalContent").html(html);
            $("#modalCrud").modal("show");
        });
    </script>
}