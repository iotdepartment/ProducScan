
@using ProducScan.ViewModels

@{
    ViewData["Title"] = "Inspección por TM";
    ViewData["Subtitle"] = "Piezas Inspeccionadas por Team Member.";
    ViewData["FullWidth"] = true;
    ViewData["HideSidebar"] = true;
}

@model List<InspeccionTMViewModel>

<style>

    #mainContent {
        margin-left: 0;
        transition: margin-left 0.3s;
    }

    
</style>

    <div class="flex items-center justify-between mb-2">
        <span id="lastUpdate" class="text-xs text-gray-600">
            Última actualización hace 0 segundos
        </span>
        <div class="flex gap-2">
            <button id="btnActualizar"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">
                🔄 Actualizar
            </button>
            <a href="@Url.Action("InspeccionTM", "PiezasEscaneadas")"
               class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">
                ⬅️ Regresar
            </a>
        </div>
    </div>
@* 
    <h5 class="font-semibold text-center mb-3">📊 Significado de colores</h5>
    <div class="flex flex-wrap justify-center gap-4 text-xs">
        <div class="flex items-center gap-1">
            <span class="w-5 h-3 rounded bg-red-300 border border-red-500"></span> Fuera de meta
        </div>
        <div class="flex items-center gap-1">
            <span class="w-5 h-3 rounded bg-yellow-400 border border-yellow-500"></span> Cerca de la meta
        </div>
        <div class="flex items-center gap-1">
            <span class="w-5 h-3 rounded bg-green-500 border border-green-600"></span> En meta
        </div>
        <div class="flex items-center gap-1">
            <span class="w-5 h-3 rounded bg-pink-600 border border-pink-700"></span> Sobreproducción
        </div>
    </div> *@

<div class="row mb-4">

    <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        @foreach (var tm in Model)
        {
            <div class="bg-white shadow-sm rounded-lg flex flex-col overflow-hidden hover:shadow-md transition transform hover:scale-105"
                 data-tm="@tm.TM" data-mesa="@tm.Mesa">

                <!-- Contenido principal compacto -->
                <div class="p-2 flex flex-col items-center text-center flex-grow space-y-1">
                    <!-- Foto reducida -->
                    <div class="w-16 h-16 mb-1">
                        <img src="@tm.FotoUrl"
                             alt="Foto de @tm.TM"
                             class="w-full h-full rounded-full border border-gray-300 shadow-sm object-cover" />
                    </div>

                    <!-- TM y Mandril -->
                    <h3 class="text-xs font-semibold text-gray-800 text-center leading-tight">
                        <i class="bi bi-person-badge me-1"></i> TM: @tm.TM
                    </h3>
                    <p class="text-xs text-gray-500">
                        <i class="bi bi-tools me-1"></i> Mandril: @tm.Mandril
                    </p>

                    <!-- Mesa -->
                    <p class="text-xs text-gray-500">
                        <i class="bi bi-grid-3x3-gap me-1"></i> Mesa: @tm.Mesa
                    </p>

                    <!-- Producción -->
                    <p class="text-xs font-semibold text-blue-600">
                        <i class="bi bi-box-seam me-1"></i> Produccion Actual
                    </p>
                    <p class="text-lg font-bold text-gray-700">@tm.TotalPiezas</p>

                    <!-- Meta esperada vs meta total -->
                    <p class="text-xs text-gray-500">
                        Meta esperada: <span class="font-semibold">@tm.MetaEsperada</span> @* / @tm.Meta *@
                    </p>

                    @* Buenas y malas (mantener comentado) *@
                    @* <p class="text-xs text-gray-500">
                    ✅ Buenas: <span class="font-semibold">@tm.PiezasBuenas</span> |
                    ❌ Malas: <span class="font-semibold">@tm.PiezasMalas</span>
                </p> *@
                </div>

                <!-- Footer con barra de progreso y estado -->
                <div class="w-full py-1 px-2 text-center text-xs font-semibold estado-footer">
                    @{
                        var porcentajeReal = (tm.Meta == 0 ? 0 : (tm.TotalPiezas * 100) / tm.Meta);
                        var porcentajeBarra = Math.Min(porcentajeReal, 100);
                    }
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full @tm.ColorClass"
                             style="width:@porcentajeBarra%">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">
                      Avance: @porcentajeReal%
                    </p>
                </div>
            </div>
        }
    </div>

</div>

@section Scripts {
    <script>
        let secondsSinceUpdate = 0;
        const lastUpdateSpan = document.getElementById("lastUpdate");
        const btnActualizar = document.getElementById("btnActualizar");

        function refreshCards() {
            // Recarga solo el contenido de #cards desde el servidor
            $("#cards").load(window.location.href + " #cards>*", function () {
                secondsSinceUpdate = 0; // reinicia contador
                lastUpdateSpan.textContent = "Última actualización hace 0 segundos";
            });
        }

        // Botón manual
        btnActualizar.addEventListener("click", refreshCards);

        // Auto-refresh cada 10 segundos
        setInterval(refreshCards, 10000);

        // Contador que incrementa cada segundo
        setInterval(function () {
            secondsSinceUpdate++;
            lastUpdateSpan.textContent = "Última actualización hace " + secondsSinceUpdate + " segundos";
        }, 1000);
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Inicializar tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Recargar cards cada 30 segundos
            setInterval(function () {
                $("#cards").load(window.location.href + " #cards>*", function () {
                    // Re-inicializar tooltips después de recargar
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                });
            }, 30000);
        });
    </script>
}

