@model PaginatedList<RegistrodePiezasEscaneada>

@{
    ViewData["Title"] = "Registro de Piezas Buenas";
    ViewData["PageTitle"] = "Registro de Piezas Buenas";
    ViewData["Subtitle"] = "Registro de Piezas buenas del día laboral actual.";
}
<div class="row mb-2">
    <div class="col-md-3">
        <button class="btn btn-success rounded-pill w-100"
                data-bs-toggle="modal"
                data-bs-target="#modalExportarExcelProduccion">
            <i class="bi bi-file-earmark-excel"></i> Generar Reporte Excel
        </button>
    </div>
</div>
        
<div class="row align-items-end mb-3">

    <!-- Fecha -->
    <div class="col-md-3">
        <label for="fechaProduccion" class="form-label fw-bold">Fecha</label>
        <input type="date" id="fechaProduccion" name="fecha"
               class="form-control rounded-pill"
               value="@ViewBag.FechaSeleccionada"
               max="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

    <!-- Mandril -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Mandril</label>

        <div class="dropdown w-100">
            <button class="btn btn-light border w-100 text-start dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown">
                Seleccionar mandriles
            </button>

            <ul class="dropdown-menu w-100 p-2" id="mandrilDropdown"
                style="max-height: 250px; overflow-y: auto;">
            </ul>
        </div>
    </div>

    <!-- Turno -->
    <div class="col-md-3">
        <label for="turnoFiltro" class="form-label fw-bold">Turno</label>
        <select id="turnoFiltro" name="turno" class="form-select rounded-pill">
            <option value="" selected="@(ViewBag.TurnoSeleccionado == "" ? "selected" : null)">Todos</option>
            <option value="1" selected="@(ViewBag.TurnoSeleccionado == "1" ? "selected" : null)">Turno 1</option>
            <option value="2" selected="@(ViewBag.TurnoSeleccionado == "2" ? "selected" : null)">Turno 2</option>
            <option value="3" selected="@(ViewBag.TurnoSeleccionado == "3" ? "selected" : null)">Turno 3</option>
        </select>
    </div>

</div>

<!-- TABLA AGRUPADA -->
<table id="tablaAgrupada" class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Turno</th>
            <th>Mandril</th>
            <th>Total Piezas</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@await Html.PartialAsync("_ExportarExcelProduccion")

@section Scripts {

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>

        /* ---------------------------------------------------------
           ✅ CARGAR MANDRILES (FILTRO PRINCIPAL)
        --------------------------------------------------------- */
        function cargarMandriles() {
            $.post('/PiezasEscaneadas/GetMandrilesPorFechaYTurno',
                {
                    fechaInicio: $('#fechaProduccion').val(),
                    fechaFin: $('#fechaProduccion').val(),
                    turno: $('#turnoFiltro').val()
                },
                function (mandriles) {

                    let contenedor = $('#mandrilDropdown');
                    contenedor.empty();

                    mandriles.forEach(m => {
                        contenedor.append(`
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" class="form-check-input me-2 mandril-check" value="${m}">
                                    ${m}
                                </label>
                            </li>
                        `);
                    });
                }
            );
        }

        /* ---------------------------------------------------------
           ✅ CARGAR MANDRILES (MODAL EXPORTACIÓN)
        --------------------------------------------------------- */
        function cargarMandrilesProduccion() {
            $.post('/PiezasEscaneadas/GetMandrilesPorFechaYTurno',
                {
                    fechaInicio: $('#fechaInicioProd').val(),
                    fechaFin: $('#fechaFinProd').val(),
                    turno: $('#turnoProd').val()
                },
                function (mandriles) {

                    let contenedor = $('#mandrilProdDropdown');
                    contenedor.empty();

                    mandriles.forEach(m => {
                        contenedor.append(`
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" class="form-check-input me-2 mandril-prod-check" value="${m}">
                                    ${m}
                                </label>
                            </li>
                        `);
                    });
                }
            );
        }

        /* ✅ Cargar mandriles del modal al abrirlo */
        $('#modalExportarExcelProduccion').on('shown.bs.modal', function () {
            cargarMandrilesProduccion();
        });

        /* ✅ Recargar mandriles del modal al cambiar filtros */
        $('#fechaInicioProd, #fechaFinProd, #turnoProd').on('change', function () {
            cargarMandrilesProduccion();
        });

        /* ✅ Obtener mandriles seleccionados del filtro principal */
        function obtenerMandrilesSeleccionados() {
            return $('.mandril-check:checked').map(function () { return this.value }).get();
        }

        /* ✅ Obtener mandriles seleccionados del modal */
        function obtenerMandrilesModal() {
            return $('.mandril-prod-check:checked').map(function () { return this.value }).get();
        }

        /* ---------------------------------------------------------
           ✅ EXPORTAR EXCEL PRODUCCIÓN
        --------------------------------------------------------- */
        $('#btnExportarExcelProduccion').on('click', function () {

            let filtros = {
                fechaInicio: $('#fechaInicioProd').val(),
                fechaFin: $('#fechaFinProd').val(),
                turno: $('#turnoProd').val(),
                mandriles: obtenerMandrilesModal()
            };

            $.ajax({
                url: '/PiezasEscaneadas/ExportarExcelProduccion',
                type: 'POST',
                data: filtros,
                xhrFields: { responseType: 'blob' },
                success: function (data) {
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "Produccion.xlsx";
                    a.click();
                }
            });
        });

        /* ---------------------------------------------------------
           ✅ DATATABLE
        --------------------------------------------------------- */
        $(document).ready(function () {

            cargarMandriles();

            var tablaAgrupada = $('#tablaAgrupada').DataTable({
                processing: true,
                ajax: {
                    url: '/PiezasEscaneadas/GetProduccionAgrupada',
                    type: 'POST',
                    data: function (d) {
                        d.fecha = $('#fechaProduccion').val();
                        d.turno = $('#turnoFiltro').val();
                        d.mandriles = obtenerMandrilesSeleccionados();
                    }
                },
                columns: [
                    // { data: 'fecha' },
                    { data: 'turno' },
                    { data: 'mandrel' },
                    { data: 'totalPiezas' }
                ],
                language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
            });

            $('#fechaProduccion, #turnoFiltro').on('change', function () {
                cargarMandriles();
                tablaAgrupada.ajax.reload();
            });

            $(document).on('change', '.mandril-check', function () {
                tablaAgrupada.ajax.reload();
            });

        });

    </script>

}