@model PaginatedList<RegistrodePiezasEscaneada>

@{
    ViewData["Title"] = "Registro de Piezas Buenas";
    ViewData["PageTitle"] = "Registro de Piezas Buenas";
    ViewData["Subtitle"] = "Registro de Piezas buenas del día laboral actual.";
}



<div class="row align-items-end mb-3">

    <div class="col-md-3">
        <a class="btn btn-success rounded-pill" asp-controller="PiezasEscaneadas" asp-action="ReporteProduccion">
            <i class="bi bi-table"></i> Reporte Inspección
        </a>
    </div>

    <!-- Fecha -->
    <div class="col-md-3">
        <label for="fechaProduccion" class="form-label fw-bold">Fecha</label>
        <input type="date" id="fechaProduccion" name="fecha"
               class="form-control rounded-pill"
               value="@ViewBag.FechaSeleccionada"
               max="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

    <!-- Mandril (Dropdown con checkboxes) -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Mandril</label>

        <div class="dropdown w-100">
            <button class="btn btn-light border w-100 text-start dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Seleccionar mandriles
            </button>

            <ul class="dropdown-menu w-100 p-2" id="mandrilDropdown"
                style="max-height: 250px; overflow-y: auto;">
                <!-- Se llena dinámicamente -->
            </ul>
        </div>
    </div>

    <!-- Turno -->
    <div class="col-md-3">
        <label for="turnoFiltro" class="form-label fw-bold"><strong>Turno</strong></label>
        <select id="turnoFiltro" name="turno" class="form-select rounded-pill">
            <option value="" selected="@(ViewBag.TurnoSeleccionado == "" ? "selected" : null)">Todos</option>
            <option value="1" selected="@(ViewBag.TurnoSeleccionado == "1" ? "selected" : null)">Turno 1</option>
            <option value="2" selected="@(ViewBag.TurnoSeleccionado == "2" ? "selected" : null)">Turno 2</option>
            <option value="3" selected="@(ViewBag.TurnoSeleccionado == "3" ? "selected" : null)">Turno 3</option>
        </select>
    </div>

</div>

<!-- TABLA AGRUPADA -->
@* <h4 class="mt-4 fw-bold">Producción Agrupada por Mandril</h4> *@

<table id="tablaAgrupada" class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Fecha</th>
            <th>Turno</th>
            <th>Mandril</th>
            <th>Total Piezas</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>





@section Scripts {

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>

        function cargarMandriles() {
            $.post('/PiezasEscaneadas/GetMandrilesPorFechaYTurno',
                {
                        fecha: $('#fechaProduccion').val(),
        turno: $('#turnoFiltro').val() // ✅ AQUÍ TAMBIÉN

                },
                function (mandriles) {

                    let contenedor = $('#mandrilDropdown');
                    contenedor.empty();

                    mandriles.forEach(m => {
                        contenedor.append(`
                            <li>
                                <label class="dropdown-item">
                                    <input type="checkbox" class="form-check-input me-2 mandril-check" value="${m}">
                                    ${m}
                                </label>
                            </li>
                        `);
                    });
                }
            );
        }

        // ✅ Obtener mandriles seleccionados
        function obtenerMandrilesSeleccionados() {
            let seleccionados = [];
            $('.mandril-check:checked').each(function () {
                seleccionados.push($(this).val());
            });
            return seleccionados;
        }

        $(document).ready(function () {

            // ✅ Cargar mandriles al iniciar
            cargarMandriles();

            // ✅ Tabla agrupada
            var tablaAgrupada = $('#tablaAgrupada').DataTable({
                processing: true,
                ajax: {
                    url: '/PiezasEscaneadas/GetProduccionAgrupada',
                    type: 'POST',
                           data: function (d) {
            d.fecha = $('#fechaProduccion').val();
            d.turno = $('#turnoFiltro').val(); // ✅ AQUÍ SE ENVÍA EL TURNO ACTUAL
            d.mandriles = obtenerMandrilesSeleccionados();
        }

                },
                columns: [
                    { data: 'fecha' },
                    { data: 'turno' },
                    { data: 'mandrel' },
                    { data: 'totalPiezas' }
                ],
                language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
            });

          
            // ✅ Recargar mandriles y tablas cuando cambie fecha o turno
            $('#fechaProduccion, #turnoFiltro').on('change', function () {
                cargarMandriles();
                tablaAgrupada.ajax.reload();
                tablaProduccion.ajax.reload();
            });

            // ✅ Recargar tablas cuando cambien los checkboxes
            $(document).on('change', '.mandril-check', function () {
                tablaAgrupada.ajax.reload();
                tablaProduccion.ajax.reload();
            });

        });

    </script>

}