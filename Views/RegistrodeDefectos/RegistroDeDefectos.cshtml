@model PaginatedList<RegistrodeDefecto>

@{
    ViewData["Title"] = "Reporte de Costos";
    ViewData["PageTitle"] = "Registro de defectos";
    ViewData["Subtitle"] = "Defectos detectados en la labor de inspección del día laboral actual.";
}

<div class="row mb-2">
    <div class="col-md-3">
        <button class="btn btn-success rounded-pill  w-100" data-bs-toggle="modal" data-bs-target="#modalExportarExcel">
            <i class="bi bi-file-earmark-excel"></i> Generar Reporte Excel
        </button>
    </div>
</div>

<div class="row align-items-end mb-3">

    <!-- Fecha -->
    <div class="col-md-3">
        <label for="fechaDefectos" class="form-label fw-bold">Fecha</label>
        <input type="date" id="fechaDefectos" name="fecha"
               class="form-control rounded-pill"
               value="@ViewBag.FechaSeleccionada"
               max="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

    <!-- Mandril (Dropdown con checkboxes) -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Mandril</label>

        <div class="dropdown w-100">
            <button class="btn btn-light border w-100 text-start dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Seleccionar mandriles
            </button>

            <ul class="dropdown-menu w-100 p-2" id="mandrilDropdown"
                style="max-height: 250px; overflow-y: auto;">
                <!-- Se llena dinámicamente -->
            </ul>
        </div>
    </div>

    <!-- Código de defecto (Dropdown con checkboxes) -->
    <div class="col-md-3">
        <label class="form-label fw-bold">Código de defecto</label>

        <div class="dropdown w-100">
            <button class="btn btn-light border w-100 text-start dropdown-toggle"
                    type="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Seleccionar códigos
            </button>

            <ul class="dropdown-menu w-100 p-2" id="codigoDropdown"
                style="max-height: 250px; overflow-y: auto;">
                <!-- Se llena dinámicamente -->
            </ul>
        </div>
    </div>

    <!-- Turno -->
    <div class="col-md-3">
        <label for="turnoFiltro" class="form-label fw-bold"><strong>Turno</strong></label>
        <select id="turnoFiltro" name="turno" class="form-select rounded-pill">

            @if (ViewBag.TurnoSeleccionado == "")
            {
                <option value="" selected>Todos</option>
            }
            else
            {
                <option value="">Todos</option>
            }

            @if (ViewBag.TurnoSeleccionado == "1")
            {
                <option value="1" selected>Turno 1</option>
            }
            else
            {
                <option value="1">Turno 1</option>
            }

            @if (ViewBag.TurnoSeleccionado == "2")
            {
                <option value="2" selected>Turno 2</option>
            }
            else
            {
                <option value="2">Turno 2</option>
            }

            @if (ViewBag.TurnoSeleccionado == "3")
            {
                <option value="3" selected>Turno 3</option>
            }
            else
            {
                <option value="3">Turno 3</option>
            }

        </select>
    </div>

</div>

<!-- TABLA AGRUPADA -->
<table id="tablaDefectos" class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Turno</th>
            <th>Mandril</th>
            <th>Total Piezas</th>
            <th>Costo</th> <!-- ✅ NUEVA COLUMNA -->
        </tr>
    </thead>
    <tbody></tbody>
</table>

@await Html.PartialAsync("_ModalExportarExcelCostos")


@section Scripts {

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>

        /* ---------------------------------------------------------
           ✅ CARGA DE MANDRILES Y CÓDIGOS (FILTROS PRINCIPALES)
        --------------------------------------------------------- */

        function cargarMandriles() {
            $.post('/RegistrodeDefectos/GetMandriles', {
                fecha: $('#fechaDefectos').val(),
                turno: $('#turnoFiltro').val()
            }, function (mandriles) {

                let contenedor = $('#mandrilDropdown');
                contenedor.empty();

                mandriles.forEach(m => {
                    contenedor.append(`
                        <li>
                            <label class="dropdown-item">
                                <input type="checkbox" class="form-check-input me-2 mandril-check" value="${m}">
                                ${m}
                            </label>
                        </li>
                    `);
                });
            });
        }

        function cargarCodigos() {
            $.post('/RegistrodeDefectos/GetCodigos', {
                fecha: $('#fechaDefectos').val(),
                turno: $('#turnoFiltro').val()
            }, function (codigos) {

                let contenedor = $('#codigoDropdown');
                contenedor.empty();

                codigos.forEach(c => {
                    contenedor.append(`
                        <li>
                            <label class="dropdown-item">
                                <input type="checkbox" class="form-check-input me-2 codigo-check" value="${c.value}">
                                ${c.text}
                            </label>
                        </li>
                    `);
                });
            });
        }

        function obtenerMandrilesSeleccionados() {
            return $('.mandril-check:checked').map(function () { return this.value }).get();
        }

        function obtenerCodigosSeleccionados() {
            return $('.codigo-check:checked').map(function () { return this.value }).get();
        }


        $(document).on("click", "#btnGenerarExcel", function () {

            let fechaInicio = $("#fechaInicioExcel").val();
            let fechaFin = $("#fechaFinExcel").val();
            let turno = $("#turnoExcel").val();

            if (!fechaInicio || !fechaFin) {
                alert("Selecciona un rango de fechas válido.");
                return;
            }

            window.location = `/RegistrodeDefectos/ExportarDefectosExcel?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&turno=${turno}`;
        });

        /* ---------------------------------------------------------
           ✅ DATATABLE (CORREGIDO Y ALINEADO)
        --------------------------------------------------------- */

        $(document).ready(function () {

            cargarMandriles();
            cargarCodigos();

                    var tabla = $('#tablaDefectos').DataTable({
            processing: true,
            serverSide: false,

            ajax: {
                url: '/RegistrodeDefectos/GetDefectosAgrupadosConCosto',
                type: 'POST',
                data: function (d) {
                    d.fecha = $('#fechaDefectos').val();
                    d.turno = $('#turnoFiltro').val();
                    d.mandriles = obtenerMandrilesSeleccionados();
                    d.codigos = obtenerCodigosSeleccionados();
                }
            },

                    columns: [
            { data: 'turno' },
            { data: 'mandril' },
            { data: 'totalPiezas' },
            { data: 'costo' },       // visible
            { data: 'costoOrden' }   // oculto
        ],

        columnDefs: [
            {
                targets: 4,
                visible: false,
                searchable: false
            },
            {
                targets: 3,
                orderData: [4] // ✅ ordenar por costoOrden
            }
        ],

        order: [[4, "desc"]],

            language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
        });

            // ✅ Recargar filtros principales
            $('#fechaDefectos, #turnoFiltro').on('change', function () {
                cargarMandriles();
                cargarCodigos();
                tabla.ajax.reload();
            });

            // ✅ Recargar tabla al cambiar checkboxes
            $(document).on('change', '.mandril-check, .codigo-check', function () {
                tabla.ajax.reload();
            });

            // ✅ Recargar modal dinámicamente
            $('#fechaInicioExcel, #turnoExcel').on('change', function () {
                cargarMandrilesExcel();
                cargarCodigosExcel();
            });

        });

    </script>

}