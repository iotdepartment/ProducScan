@model IEnumerable<ProducScan.Models.Log>
@{
    ViewData["Title"] = "Logs del Sistema";
}

<style>
    .arrow-toggle i {
        display: inline-block;
        transition: transform 0.3s ease; /* 👈 transición suave */
    }

    .arrow-toggle.open i {
        transform: rotate(90deg); /* rota la flecha al abrir */
    }
</style>

<div class="row mb-3">
    <div class="col-md-3">
        <label for="filtroNivel" class="form-label fw-bold">Nivel</label>
        <select id="filtroNivel" class="form-select rounded-pill">
            <option value="all">Todos</option>
            <option value="Info">Info</option>
            <option value="Warning">Warning</option>

            @if (User.IsInRole("Admin"))
            {
                <option value="Error">Error</option>
                <option value="Critical">Critical</option>
            }
        </select>
    </div>
    @if (User.IsInRole("Admin"))
    {
        <div class="col-md-3">
            <label for="filtroCategoria" class="form-label fw-bold">Categoría</label>
            <select id="filtroCategoria" class="form-select rounded-pill">
                <option value="all">Todas</option>
                <option value="Producción">Producción</option>
                <option value="Sistema">Sistema</option>
            </select>
        </div>
    }
    <div class="col-md-3">
        <label for="filtroFecha" class="form-label fw-bold">Fecha</label>
        <input type="date" id="filtroFecha" class="form-control rounded-pill" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

</div>


<div id="logsContainer" class="p-2 text-muted">
    @await Html.PartialAsync("_TablaLogs", Model)
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let state = { nivel: "all", categoria: "all", fecha: "" };

        function cargarLogs() {
            const { nivel, categoria, fecha } = state;
            const qNivel = encodeURIComponent(nivel);
            const qCat = encodeURIComponent(categoria);
            const qFecha = encodeURIComponent(fecha || "");

            $("#logsContainer").load(`/Logs/TablaLogs?nivel=${qNivel}&categoria=${qCat}&fecha=${qFecha}`, function () {
                var table = $('#logsTable').DataTable({
                    destroy: true,
                    pageLength: 10,
                    lengthMenu: [10, 20, 50, 100],
                    order: [[0, "desc"]],
                    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" },
                    columnDefs: [{ orderable: false, targets: 0 }]
                });


                  $('#logsTable tbody').on('click', '.arrow-toggle', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);
                var arrow = $(this);

                if (row.child.isShown()) {
                    // Cerrar
                    $('div.slider', row.child()).slideUp(300, function () {
                        row.child.hide();
                        tr.removeClass('shown');
                        arrow.removeClass('open');
                    });
                } else {
                    // Abrir
                    var detalles = tr.data('detalles');
                    row.child(
                        `<div class="slider bg-light p-2">
                            <strong>Detalles:</strong><br/>${detalles}
                            </div>`
                    ).show();

                    $('div.slider', row.child()).hide().slideDown(300);
                    tr.addClass('shown');
                    arrow.addClass('open');
                }
            });
          
            });
        }


        $(document).on("change", "#filtroNivel", function () {
            state.nivel = $(this).val();
            cargarLogs();
        });

        $(document).on("change", "#filtroCategoria", function () {
            state.categoria = $(this).val();
            cargarLogs();
        });

        $(document).on("change", "#filtroFecha", function () {
            state.fecha = $(this).val();
            cargarLogs();
        });

        // ⚡ Cargar logs al entrar a la vista
        $(document).ready(function () {
            cargarLogs();
        });
    </script>
}
