@{
    ViewData["Title"] = "Mandriles";
    ViewData["Subtitle"] = "Mandriles registrados en el Sistema de escaneo de Inspección.";
}



<div class="row">
    <div class="col-3">

        <button class="btn btn-success mb-3 rounded rounded-pill w-100" data-bs-toggle="modal" data-bs-target="#createEditModal"
                onclick="openCreateModal()">
            <i class="bi bi-plus-circle"></i>
            Nuevo Mandril
        </button>


    </div>
</div>

<table id="mandrilesTable" class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Mandril</th>
            <th>Centro de Costos</th>
            <th>Cantidad de Empaque</th>
            <th>Barcode</th>
            <th>Kanban</th>
            <th>Estación</th>
            <th>Familia</th>     
            <th>Proceso</th>     
            <th>Peso Min</th>
            <th>Peso Max</th>
            <th class="text-center">Acciones</th>

        </tr>
    </thead>
</table>

<!-- Toast único -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
    <div id="mainToast" class="toast align-items-center border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Mensaje aquí</div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Partial con modal Create/Edit -->
@await Html.PartialAsync("_CreateEditMandrilModal")

<!-- Modal Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteForm" asp-action="Delete" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar Mandril</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deleteId" name="id" />
                    <p>¿Seguro que deseas eliminar este mandril?</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        var table;

        $(document).ready(function () {

            /* ============================
               DATATABLE
            ============================ */
                    table = $('#mandrilesTable').DataTable({
            ajax: {
                url: "/Mandriles/GetMandriles",
                type: "GET",
                datatype: "json"
            },
            columns: [
                { data: "mandrilNombre" },
                { data: "centrodeCostos" },
                { data: "cantidaddeEmpaque" },
                { data: "barcode" },
                { data: "kanban" },
                { data: "estacion" },
                { data: "familia" },
                { data: "proceso" },
                { data: "pesomin" },
                { data: "pesomax" },
                {
                    data: "id",
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-sm btn-warning rounded-pill"
                                onclick="openEditModal(${data},
                                                      '${row.mandrilNombre}',
                                                      '${row.centrodeCostos}',
                                                      '${row.cantidaddeEmpaque}',
                                                      '${row.barcode}',
                                                      '${row.kanban}',
                                                      '${row.estacion ?? ""}',
                                                      '${row.familia ?? ""}',
                                                      '${row.proceso ?? ""}',
                                                      '${row.pesomin ?? ""}',
                                                      '${row.pesomax ?? ""}')">
                                <i class="bi bi-pencil-fill"></i>
                            </button>

                            <button class="btn btn-sm btn-danger rounded-pill"
                                onclick="openDeleteModal(${data})">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        `;
                    }
                }
            ],
            columnDefs: [
                { className: "text-center", targets: 10 }
            ],
            pageLength: 10,
            lengthMenu: [10, 20, 50, 100],
            ordering: false,
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" }
        });

            /* ============================
               SUBMIT CREATE / EDIT
            ============================ */
            $("#createEditForm").submit(function (e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    type: "POST",
                    url: form.attr("action"),
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $('#createEditModal').modal('hide');
                            showToast(res.message, true);
                            table.ajax.reload(null, false);
                        } else {
                            showToast(res.message, false);
                        }
                    }
                });
            });

            /* ============================
               SUBMIT DELETE
            ============================ */
            $("#deleteForm").submit(function (e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    type: "POST",
                    url: form.attr("action"),
                    data: form.serialize(),
                    success: function (res) {
                        if (res.success) {
                            $('#deleteModal').modal('hide');
                            showToast(res.message, true);
                            table.ajax.reload(null, false);
                        } else {
                            showToast(res.message, false);
                        }
                    }
                });
            });

        });

        /* ============================
           RESET AUTOMÁTICO DEL MODAL
        ============================ */
        $('#createEditModal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
            $(this).find('form').removeClass('was-validated');
        });

        /* ============================
           MODO CREAR
        ============================ */
        function openCreateModal() {

            document.getElementById("modalTitle").innerText = "Nuevo Mandril";

            const header = document.querySelector("#createEditModal .modal-header");
            header.classList.remove("bg-warning", "text-dark");
            header.classList.add("bg-success", "text-white");

            const saveBtn = document.getElementById("saveBtn");
            saveBtn.innerText = "Guardar";
            saveBtn.classList.remove("btn-warning");
            saveBtn.classList.add("btn-success");

            document.getElementById("createEditForm").action = "/Mandriles/Create";

            // Limpiar campos
            document.getElementById("mandrilId").value = "";
            document.getElementById("mandrilNombre").value = "";
            document.getElementById("centrodeCostos").value = "";
            document.getElementById("cantidaddeEmpaque").value = "";
            document.getElementById("barcode").value = "";
            document.getElementById("kanban").value = "";
            document.getElementById("estacion").value = "";
            document.getElementById("familia").value = "";
            document.getElementById("proceso").value = "";
            document.getElementById("pesomin").value = "";
            document.getElementById("pesomax").value = "";
        }

        /* ============================
           MODO EDITAR
        ============================ */
        function openEditModal(id, mandrilNombre, centrodeCostos, cantidaddeEmpaque, barcode, kanban, estacion, familia, proceso, pesomin, pesomax) {

            document.getElementById("modalTitle").innerText = "Editar Mandril";

            const header = document.querySelector("#createEditModal .modal-header");
            header.classList.remove("bg-success", "text-white");
            header.classList.add("bg-warning", "text-dark");

            const saveBtn = document.getElementById("saveBtn");
            saveBtn.innerText = "Actualizar";
            saveBtn.classList.remove("btn-success");
            saveBtn.classList.add("btn-warning");

            document.getElementById("createEditForm").action = "/Mandriles/Edit";

            document.getElementById("mandrilId").value = id;
            document.getElementById("mandrilNombre").value = mandrilNombre;
            document.getElementById("centrodeCostos").value = centrodeCostos;
            document.getElementById("cantidaddeEmpaque").value = cantidaddeEmpaque;
            document.getElementById("barcode").value = barcode;
            document.getElementById("kanban").value = kanban;
            document.getElementById("estacion").value = estacion || "";
            document.getElementById("familia").value = familia || "";
            document.getElementById("proceso").value = proceso || "";
            document.getElementById("pesomin").value = pesomin || "";
            document.getElementById("pesomax").value = pesomax || "";

            $('#createEditModal').modal('show');
        }

        /* ============================
           MODAL ELIMINAR
        ============================ */
        function openDeleteModal(id) {
            document.getElementById("deleteId").value = id;
            $('#deleteModal').modal('show');
        }

        /* ============================
           TOAST
        ============================ */
        function showToast(message, isSuccess = true) {
            const toastEl = document.getElementById("mainToast");
            const toastBody = document.getElementById("toastMessage");

            toastEl.classList.remove("text-bg-success", "text-bg-danger");
            toastEl.classList.add(isSuccess ? "text-bg-success" : "text-bg-danger");

            toastBody.innerText = message;

            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

    </script>
}